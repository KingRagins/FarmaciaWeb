// ==================== DEBUG COMPLETO ====================
console.log("ğŸ”§ DEBUG: carrito.js iniciando...");

// Verificar que jQuery no estÃ© causando conflictos
if (typeof $ !== 'undefined') {
    console.log("âš ï¸ jQuery detectado:", $().jquery);
} else {
    console.log("âœ… Sin jQuery - usando vanilla JS");
}

// Verificar que Bootstrap estÃ© cargado
if (typeof bootstrap !== 'undefined') {
    console.log("âœ… Bootstrap detectado");
} else {
    console.log("âŒ Bootstrap NO detectado");
}

// Verificar que los elementos del carrito existen
document.addEventListener('DOMContentLoaded', function() {
    console.log("ğŸ¯ DOM completamente cargado");
    
    // Contar elementos del carrito
    const productos = document.querySelectorAll('.producto-item');
    console.log(`ğŸ“¦ Productos en el carrito: ${productos.length}`);
    
    // Verificar botones
    const botonesEliminar = document.querySelectorAll('.eliminar-producto');
    const botonesRestar = document.querySelectorAll('.restar-cantidad');
    const botonesSumar = document.querySelectorAll('.sumar-cantidad');
    const botonVaciar = document.querySelector('.vaciar-carrito');
    
    console.log(`ğŸ—‘ï¸ Botones eliminar: ${botonesEliminar.length}`);
    console.log(`â– Botones restar: ${botonesRestar.length}`);
    console.log(`â• Botones sumar: ${botonesSumar.length}`);
    console.log(`ğŸ§¹ BotÃ³n vaciar: ${botonVaciar ? 'SÃ' : 'NO'}`);
    
    // Verificar que los botones tengan los data attributes necesarios
    productos.forEach((producto, index) => {
        const id = producto.getAttribute('data-id');
        console.log(`ğŸ“‹ Producto ${index + 1}: ID = ${id}`);
    });
    
    // Inicializar el carrito
    try {
        console.log("ğŸ›’ Inicializando clase Carrito...");
        new Carrito();
    } catch (error) {
        console.error("ğŸ’¥ ERROR al inicializar Carrito:", error);
    }
});

class Carrito {
    constructor() {
        console.log("ğŸš€ Constructor de Carrito ejecutado");
        this.initEventListeners();
    }
    mostrarMensaje(mensaje, tipo) {
        // MÃ©todo simple de alertas
        if (tipo === 'success') {
            alert('âœ… ' + mensaje);
        } else {
            alert('âŒ ' + mensaje);
        }
    }
    initEventListeners() {
        console.log("ğŸ”— Iniciando event listeners...");
        
        try {
            // BotÃ³n eliminar
            const eliminarBtns = document.querySelectorAll('.eliminar-producto');
            console.log(`ğŸ” Encontrados ${eliminarBtns.length} botones eliminar`);
            
            eliminarBtns.forEach((btn, index) => {
                btn.addEventListener('click', (e) => {
                    console.log(`ğŸ—‘ï¸ Click en eliminar producto ${index + 1}`);
                    this.eliminarProducto(e);
                });
            });

            // Botones restar cantidad
            const restarBtns = document.querySelectorAll('.restar-cantidad');
            console.log(`ğŸ” Encontrados ${restarBtns.length} botones restar`);
            
            restarBtns.forEach((btn, index) => {
                btn.addEventListener('click', (e) => {
                    console.log(`â– Click en restar cantidad ${index + 1}`);
                    this.cambiarCantidad(e, -1);
                });
            });

            // Botones sumar cantidad
            const sumarBtns = document.querySelectorAll('.sumar-cantidad');
            console.log(`ğŸ” Encontrados ${sumarBtns.length} botones sumar`);
            
            sumarBtns.forEach((btn, index) => {
                btn.addEventListener('click', (e) => {
                    console.log(`â• Click en sumar cantidad ${index + 1}`);
                    this.cambiarCantidad(e, 1);
                });
            });

            // Vaciar carrito
            const vaciarBtn = document.querySelector('.vaciar-carrito');
            if (vaciarBtn) {
                console.log("ğŸ” BotÃ³n vaciar carrito encontrado");
                vaciarBtn.addEventListener('click', () => {
                    console.log("ğŸ§¹ Click en vaciar carrito");
                    this.vaciarCarrito();
                });
            } else {
                console.log("âŒ BotÃ³n vaciar carrito NO encontrado");
            }
            
            console.log("âœ… Todos los event listeners configurados");
            
        } catch (error) {
            console.error("ğŸ’¥ ERROR en initEventListeners:", error);
        }
    }

    async eliminarProducto(e) {
    console.log("ğŸ”´ Iniciando eliminaciÃ³n de producto...");
    try {
        const item = e.target.closest('.producto-item');
        if (!item) {
            console.error("âŒ No se pudo encontrar el elemento producto");
            return;
        }
        
        const idDetalle = item.dataset.id;
        console.log(`ğŸ“‹ ID del producto a eliminar: ${idDetalle}`);
        
        if (!confirm('Â¿EstÃ¡s seguro de que quieres eliminar este producto del carrito?')) {
            console.log("âŒ EliminaciÃ³n cancelada por el usuario");
            return;
        }

        console.log("ğŸŒ Enviando solicitud a eliminar_carrito.php...");
        const response = await fetch('../controladores/carrito/eliminar_carrito.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `id_detalle_car=${idDetalle}`
        });

        console.log("ğŸ“¡ Respuesta recibida, status:", response.status);
        
        // VERIFICAR SI LA RESPUESTA ES JSON VÃLIDO
        const text = await response.text();
        console.log("ğŸ“„ Respuesta cruda:", text);
        
        let result;
        try {
            result = JSON.parse(text);
        } catch (parseError) {
            console.error("âŒ La respuesta NO es JSON vÃ¡lido:", text);
            alert('Error del servidor: respuesta invÃ¡lida');
            return;
        }
        
        console.log("ğŸ“Š Resultado parseado:", result);

        if (result.success) {
            console.log("âœ… Producto eliminado exitosamente");
            item.remove();
            this.mostrarMensaje('Producto eliminado del carrito', 'success');
            
            if (!document.querySelector('.producto-item')) {
                console.log("ğŸ”„ Recargando pÃ¡gina (carrito vacÃ­o)");
                location.reload();
            }
        } else {
            console.error("âŒ Error del servidor:", result.message);
            this.mostrarMensaje(result.message, 'error');
        }
    } catch (error) {
        console.error("ğŸ’¥ ERROR en eliminarProducto:", error);
        this.mostrarMensaje('Error al eliminar producto', 'error');
    }
}

    async cambiarCantidad(e, cambio) {
        console.log(`ğŸ”„ Cambiando cantidad: ${cambio}`);
        try {
            const item = e.target.closest('.producto-item');
            if (!item) {
                console.error("âŒ No se pudo encontrar el elemento producto");
                return;
            }
            
            const idDetalle = item.dataset.id;
            const cantidadElement = item.querySelector('.cantidad');
            let cantidad = parseInt(cantidadElement.textContent);
            
            console.log(`ğŸ“‹ ID: ${idDetalle}, Cantidad actual: ${cantidad}, Cambio: ${cambio}`);
            
            const nuevaCantidad = cantidad + cambio;

            if (nuevaCantidad < 1) {
                console.log("ğŸ—‘ï¸ Cantidad serÃ­a 0, eliminando producto...");
                this.eliminarProducto(e);
                return;
            }

            console.log("ğŸŒ Enviando solicitud de actualizaciÃ³n...");
            const response = await fetch('../controladores/actualizar_cantidad_carrito.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `id_detalle_car=${idDetalle}&cantidad=${nuevaCantidad}`
            });

            console.log("ğŸ“¡ Respuesta recibida, status:", response.status);
            const result = await response.json();
            console.log("ğŸ“Š Resultado:", result);

            if (result.success) {
                if (result.eliminado) {
                    console.log("âœ… Producto eliminado por cantidad 0");
                    item.remove();
                    if (!document.querySelector('.producto-item')) {
                        console.log("ğŸ”„ Recargando pÃ¡gina (carrito vacÃ­o)");
                        location.reload();
                    }
                } else {
                    console.log(`âœ… Cantidad actualizada a: ${nuevaCantidad}`);
                    cantidadElement.textContent = nuevaCantidad;
                }
                this.actualizarContadorNavbar();
                this.mostrarMensaje('Cantidad actualizada', 'success');
            } else {
                console.error("âŒ Error del servidor:", result.message);
                this.mostrarMensaje(result.message, 'error');
            }
        } catch (error) {
            console.error("ğŸ’¥ ERROR en cambiarCantidad:", error);
            this.mostrarMensaje('Error al actualizar cantidad', 'error');
        }
    }

    async vaciarCarrito() {
        console.log("ğŸ§¹ Iniciando vaciado de carrito...");
        try {
            if (!confirm('Â¿EstÃ¡s seguro de que quieres vaciar todo el carrito?')) {
                console.log("âŒ Vaciado cancelado por el usuario");
                return;
            }

            console.log("ğŸŒ Enviando solicitud a vaciar_carrito.php...");
            const response = await fetch('../controladores/vaciar_carrito.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
            });

            console.log("ğŸ“¡ Respuesta recibida, status:", response.status);
            const result = await response.json();
            console.log("ğŸ“Š Resultado:", result);

            if (result.success) {
                console.log("âœ… Carrito vaciado exitosamente");
                this.mostrarMensaje('Carrito vaciado', 'success');
                setTimeout(() => {
                    console.log("ğŸ”„ Recargando pÃ¡gina...");
                    location.reload();
                }, 1000);
            } else {
                console.error("âŒ Error del servidor:", result.message);
                this.mostrarMensaje(result.message, 'error');
            }
        } catch (error) {
            console.error("ğŸ’¥ ERROR en vaciarCarrito:", error);
            this.mostrarMensaje('Error al vaciar carrito', 'error');
        }
    }

    // ... resto de tus mÃ©todos (actualizarContadorNavbar, mostrarMensaje, etc.)
}

console.log("ğŸ“ Clase Carrito definida, esperando DOM...");
// ==================== FIN DEBUG ====================
